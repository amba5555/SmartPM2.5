# Implementation Checklist: Hyperlocal Air Quality Platform (Phase 1 MVP)

**Version:** 1.2
**Date:** September 30, 2025 (Updated)
**Based on PRD:** Hyperlocal Air Quality & Health Forecast Platform
**Goal:** Build end-to-end data pipeline and dashboard for real-time AQI monitoring.
**Timeline:** 4â€“6 weeks (10â€“15 hours/week).
**Tools:** VS Code, GitHub, Supabase, Render, Vercel.
**Current Status:** Core MVP pipeline working, frontend deployment troubleshooting in progress.

---

## Prerequisites
- [x] ESP32 firmware deployed and publishing to HiveMQ Cloud (see firmware topic note below). âœ… **WORKING RELIABLY**
- [x] GitHub repository for source control. âœ… **COMPLETE**
- [x] Accounts created: Supabase (free), Render (free), Vercel (free), HiveMQ Cloud (free). âœ… **COMPLETE**
- [x] Basic knowledge: Python (backend), JavaScript (frontend), SQL (database). âœ… **APPLIED**

Note: The backend implementation in this repo expects the device to publish to the dotted-topic form `smartpm25.sensor.data` (not `smartpm25/sensor/data`). The backend also requires TLS on MQTT (port 8883).
- [ ] GitHub repository for source control.
- [ ] Accounts created: Supabase (free), Render (free), Vercel (free), HiveMQ Cloud (free).
- [ ] Basic knowledge: Python (backend), JavaScript (frontend), SQL (database).

---

## 1. Database Setup (Supabase)
**Goal:** Create secure, scalable storage for sensor data.
**Estimated time:** 1â€“2 days.
**STATUS:** âœ… **COMPLETE AND WORKING**

- [x] Create a new Supabase project.
- [x] In the SQL editor, run the schema script (or use the provided `web/backend/sql/schema.sql`). Example schema:

```sql
CREATE TABLE readings (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  device_id TEXT NOT NULL,
  pm1 INTEGER NOT NULL,
  pm25 INTEGER NOT NULL,
  pm10 INTEGER NOT NULL,
  aqi INTEGER NOT NULL,
  timestamp BIGINT NOT NULL,
  wifi_rssi INTEGER,
  ip_address TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX readings_device_id_idx ON readings(device_id);
CREATE INDEX readings_timestamp_idx ON readings(timestamp);
```

- [x] Enable Row Level Security (RLS) and add policies for read access (or use Supabase Edge Functions for controlled access).
- [x] Insert sample data to validate the schema.
- [x] Record: Project URL, anon (public) key, and service role key (store securely).

Success criteria: table exists and sample data is insertable/queryable.

Important note about uniqueness and idempotency
- The backend uses upsert to make writes idempotent. To enforce uniqueness at the DB level, you can add a unique constraint on (device_id, timestamp) â€” but only after you remove any existing duplicates. See `web/backend/sql/add_unique_constraint.sql` for guidance and `web/backend/sql/cleanup_duplicates.sql` (included) to preview and remove duplicates before applying the constraint.

---

## 2. Backend Setup (Python + FastAPI on Render)
**Goal:** Subscribe to MQTT, validate/process incoming messages, store them in Supabase, and expose APIs for the frontend.
**Estimated time:** 2â€“4 days (backend skeleton exists in `web/backend`).
**STATUS:** âœ… **COMPLETE AND WORKING RELIABLY**

**Additional Infrastructure:**
- [x] Railway cron job implemented for Render wake-up pings âœ… **WORKING**
- [x] Database-side aggregation functions implemented for efficient time-series queries
- [x] MQTTâ†’Supabase pipeline stable and reliable

Key implemented decisions (this repo):
- Python runtime: 3.11 (run tests and venv with python3.11). Many dependencies in the Supabase stack require 3.11 compatibility.
- MQTT: paho-mqtt with TLS (connects to broker on port 8883) and uses the dotted topic `smartpm25.sensor.data`.
- DB writes: backend uses upsert (idempotent writes). The code defers Supabase client creation until startup and includes retry/backoff for transient errors.

Quick local dev steps (in `web/backend`):

```bash
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

Environment variables required (set in `.env` or Render env):
- SUPABASE_URL
- SUPABASE_KEY (service role or anon depending on usage; keep service role secret)
- MQTT_BROKER
- MQTT_USERNAME
- MQTT_PASSWORD
- BACKEND_LOG_PATH (optional; rotating file handler is configured)
- DEBUG_MQTT_TOKEN (optional; used to gate the debug endpoint)

Testing and utilities included:
- `web/backend/test_mqtt.py` â€” TLS-enabled publisher (example device simulator) that publishes to `smartpm25.sensor.data`.
- `web/backend/tests/test_integration.py` â€” pytest integration test that publishes a message and polls the API until the record appears.

Render deployment notes
- Repository Root for the Render service: set to `web/backend` (Render "Root Directory").
- Build command: none (dependencies installed at runtime using the virtualenv created by Render), or set to `pip install -r requirements.txt` if custom build is required.
- Start command (Render web service):

```bash
uvicorn main:app --host 0.0.0.0 --port $PORT
```

Success criteria: backend receives MQTT messages (TLS) and writes to Supabase; APIs return expected JSON. Monitor logs in Render and locally.

---

## 3. Frontend Setup (Svelte + SvelteKit on Vercel)
**Goal:** Responsive dashboard showing live AQI, recent readings, and historical charts.  
**Estimated time:** 4â€“6 days.
**STATUS:** ðŸ”„ **LOCAL: COMPLETE, VERCEL: DEPLOYMENT ISSUES**

- [ ] Scaffold SvelteKit app:

```bash
npm create svelte@latest frontend
cd frontend
npm install
```

- [ ] Add dependencies:

```bash
npm install @supabase/supabase-js chart.js
```

- [x] Configure Supabase client in `src/lib/supabase.js` (use anon/public key for read-only frontend queries).
- [x] Build main UI components:
  - [x] AQI card / gauge (color-coded by AQI level).
  - [x] Current readings (PM1, PM2.5, PM10, RSSI, IP).
  - [x] Health recommendations component (based on AQI bands).
  - [x] Historical chart component (24h, 7d, 30d) using Chart.js.
  - [x] **Beautiful Bar Chart**: IQAir-inspired design with AQI colors
  - [x] **Timezone Support**: GMT+7 conversion for local time display
  - [x] **Server Timestamps**: Use `created_at` for proper chronological ordering

- [x] Data flow:
  - [x] Fetch latest reading on page load.
  - [x] Poll backend every 10s with retry/backoff logic.
  - [x] Wake backend functionality for Render auto-sleep handling.
  - [ ] Allow selecting device_id to view different sensors (multi-sensor support).

- [x] **Chart Enhancements**:
  - [x] Dynamic AQI-based bar colors (Greenâ†’Yellowâ†’Orangeâ†’Redâ†’Purple)
  - [x] Rounded bars with modern styling
  - [x] Gradient container background
  - [x] Enhanced tooltips with PM2.5 and AQI values
  - [x] Smooth animations and transitions
  - [x] Responsive design for mobile/desktop

- [x] Test locally (`npm run dev`) and verify layout on desktop and mobile.
- [x] Deploy to Vercel (connect GitHub repo, set env vars for production if needed). ðŸ”„ **DEPLOYED BUT ASSET ROUTING ISSUES**

**Current Vercel Issue:** Static assets (JS/CSS) return HTML content instead of proper files, causing MIME type errors in browser. Investigation shows filesystem routing in vercel.json needs refinement.

**Success criteria:** Dashboard displays live data and historical charts, updates within 10s.  
**Notes / Risks:** If Svelte becomes a blocker, implement a minimal static page with plain JS and Chart.js and migrate later.

---

## 4. Integration & Testing
**Goal:** Validate end-to-end pipeline and user experience.  
**Estimated time:** 2â€“3 days.
**STATUS:** âœ… **CORE PIPELINE COMPLETE** ðŸ”„ **FRONTEND DEPLOYMENT PENDING**

- [x] Point device(s) to HiveMQ Cloud and confirm messages appear in backend logs (backend requires TLS and uses `smartpm25.sensor.data`). âœ… **WORKING RELIABLY**
- [x] Verify records appear in Supabase and that upserts prevent duplicates from duplicate deliveries. âœ… **VERIFIED**
- [x] Confirm frontend shows latest reading and history charts. âœ… **LOCAL WORKING**
- [x] Validate AQI calculations and health messages. âœ… **VERIFIED**
- [x] Test multi-device flows and filters. âœ… **WORKING**
- [ ] Run integration tests:

```bash
# from web/backend with venv active
pytest -q
```

- [ ] Load test (basic): ensure latency < 10s and system handles expected message rate.

Success criteria: full pipeline validated; tests pass and system is stable with expected message rates.

**Success criteria:** Full pipeline validated; visible on staging/production URLs.
**Current Status:** âœ… Pipeline validated locally and in staging. ðŸ”„ Production frontend deployment troubleshooting in progress (asset routing issue).

**Immediate Next Steps:**
- [ ] Resolve Vercel static asset MIME type issue
- [ ] Verify production frontend fully functional
- [ ] Complete end-to-end production validation

---

## 5. Documentation & Handover
**Goal:** Make the project reproducible and maintainable.  
**Estimated time:** 1â€“2 days.


- [ ] Add `docs/README.md` with quick-start steps for local dev, deploy, and DB setup (this checklist is a companion).
- [ ] Add `.env.example` with variable names and descriptions (see `web/backend/.env.example`).
- [ ] Document API endpoints and sample responses (see `web/backend/README.md`).
- [ ] Provide a troubleshooting section (common MQTT, network, and Supabase errors). The backend logs helpful MQTT flags (mid/dup/retain) on receipt.

Success criteria: new team members can follow README to run the system locally.

**Success criteria:** New team members can follow README to run the system locally.

---

## Phase 2 (Optional / Future)
- [ ] Research 24-hour AQI forecasting models (time series or simple ML).
- [ ] Prepare data pipeline for model training (export historical data from Supabase).
- [ ] Build alerting (email/SMS) for predicted high pollution events.

---

## Notes & References
- PRD: `docs/PRD.md`  
- Firmware: see `src/` (ESP32 code)  
- Keep secrets out of Git; use `include/MQTTConfig.example.h` for templates and add real files to `.gitignore`.

---

*Check items off as you complete them. If you want, I can create separate task issues on GitHub from this checklist.*